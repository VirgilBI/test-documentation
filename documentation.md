# Tables

## jaffle_shop.customers
| Column Name | Type | Joins To |
|------------|------|----------|
| id | INT | jaffle_shop.orders.user_id |
| first_name | TEXT | |
| last_name | TEXT | |
| created_at | DATE | |
| billing_id | INT | |

## jaffle_shop.orders
| Column Name | Type | Joins To |
|------------|------|----------|
| id | INT | jaffle_shop.payments.order_id, jaffle_shop.order_line_items.order_id |
| user_id | INT | jaffle_shop.customers.id |
| order_date | DATE | |
| status | TEXT | |

## jaffle_shop.payments
| Column Name | Type | Joins To |
|------------|------|----------|
| id | INT | |
| order_id | INT | jaffle_shop.orders.id |
| payment_method | TEXT | |
| amount | DECIMAL | |

**Note**: When calculating spend, always exclude coupons unless explicitly told to include them.

## jaffle_shop.order_line_items
| Column Name | Type | Joins To |
|------------|------|----------|
| line_item_id | INT | |
| order_id | INT | jaffle_shop.orders.id |
| price | DECIMAL | |

## jaffle_shop.billable_entities
| Column Name | Type | Joins To |
|------------|------|----------|
| billing_id | INT | |
| billable_status | BOOL | |

# Key Business Definitions and Sample Queries

## Total Spend Per Customer
### Definition: Calculates the total amount each customer has spent, excluding payments made with coupons.
### Sample Query:
```
sql
Copy
SELECT 
    c.id AS customer_id,
    c.first_name,
    c.last_name,
    SUM(p.amount) AS total_spent
FROM 
    jaffle_shop.customers c
JOIN 
    jaffle_shop.orders o ON c.id = o.user_id
JOIN 
    jaffle_shop.payments p ON o.id = p.order_id
WHERE 
    p.payment_method != 'coupon'
GROUP BY 
    c.id, c.first_name, c.last_name
ORDER BY 
    total_spent DESC;
```

## Monthly Active Users
### Definition: The number of users that make at least one purchase per month.
### Sample Query:
```
sql
SELECT
    date_trunc('month', order_date) as order_month,
    COUNT(DISTINCT o.user_id) AS active_users
FROM
    jaffle_shop.orders o
JOIN
    jaffle_shop.payments p ON o.id = p.order_id
WHERE
    p.payment_method != 'coupon'
GROUP BY
    order_month
ORDER BY
    order_month;
```

## Revenue by Line Item and Month
### Definition: The total revenue generated by each line item per month, including orders without specific line items.
### Sample Query:
```
sql
WITH order_revenue AS (
    SELECT
        o.id AS order_id,
        o.order_date,
        COALESCE(oli.line_item_id, 1) AS line_item_id,
        COALESCE(oli.price, p.amount) AS revenue
    FROM
        jaffle_shop.orders o
    LEFT JOIN
        jaffle_shop.order_line_items oli ON o.id = oli.order_id
    JOIN
        jaffle_shop.payments p ON o.id = p.order_id
    WHERE
        p.payment_method != 'coupon'
),
monthly_revenue AS (
    SELECT
        date_trunc('month', order_date) as order_month,
        line_item_id,
        SUM(revenue) AS revenue
    FROM
        order_revenue
    GROUP BY
        order_month,
        line_item_id
)
SELECT
    order_month,
    line_item_id,
    revenue
FROM
    monthly_revenue
ORDER BY
    order_month, line_item_id;
```

## GA (General Availability)
### Definition: The date we went live with our product. 1/1/2024.

# Important Notes for Querying
1. Date Functions: Use EXTRACT(YEAR FROM date_column) and EXTRACT(MONTH FROM date_column) for year and month extraction to ensure compatibility across different SQL dialects.
1. String Concatenation: Use CONCAT() function or the || operator (depending on your SQL dialect) for string concatenation.
1. Coupon Payments: Unless specified otherwise, exclude payments made with coupons in spend calculations.
1. Date Ranges: When filtering for post-GA data, use order_date >= '2024-01-01' in your WHERE clause.
1. Orders Without Line Items: For orders that exist but have no associated line items, assume they're associated with line_item_id = 1. Use COALESCE(oli.line_item_id, 1) when joining with the order_line_items table. When we first launched, we only had one product (our standard plan) and we didn’t need to track individual line items within an order. Therefore, when you see an order without any associated line items it’s safe to assume that it’s a standard plan order.
1. Revenue Calculation: When calculating revenue, use COALESCE(oli.price, p.amount) to account for orders with and without line items.
1. Data Types: Be aware of the data types in each column and use appropriate type casting when necessary.
